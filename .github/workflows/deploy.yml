name: Deploy (dev)

on:
  push:
    branches: ["dev"]

concurrency:
  group: deploy-dev
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script: |
            set -euo pipefail

            # Przejdź do folderu projektu
            cd "${{ secrets.DEPLOY_PATH }}"

            # 1. Naprawa uprawnień przed operacjami Git
            # Docker mógł utworzyć pliki jako root, co blokuje 'git reset'
            sudo chown -R $USER:$USER .

            # 2. Zatrzymaj kontenery
            # Robimy to przed resetem, aby zwolnić blokady plików (file locks)
            docker compose down || true

            # 3. Aktualizacja kodu
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            # 4. Przygotowanie pliku .env
            if [ -f backend/.env.docker ] && [ ! -f backend/.env ]; then
              cp -f backend/.env.docker backend/.env
            fi
            
            # Naprawa ewentualnych błędów w strukturze .env
            sed -i 's/^APP_KEY$/APP_KEY=/' backend/.env || true
            grep -q '^APP_KEY=' backend/.env || echo 'APP_KEY=' >> backend/.env

            # 5. Budowanie i uruchamianie obrazów
            docker compose up -d --build

            # 6. Instalacja zależności PHP (wewnątrz kontenera)
            docker compose exec -T php composer install --no-dev --optimize-autoloader

            # 7. Generowanie klucza aplikacji (tylko jeśli go nie ma)
            docker compose exec -T php sh -lc 'grep -q "^APP_KEY=base64:" .env || php artisan key:generate --force'

            # 8. Opcjonalne: Migracje bazy danych
            # docker compose exec -T php php artisan migrate --force

            # 9. Przywrócenie uprawnień dla serwera WWW wewnątrz kontenera
            # Ważne, aby Laravel mógł pisać logi i cache
            docker compose exec -T php chown -R www-data:www-data storage bootstrap/cache

            # 10. Restart workerów
            docker compose restart queue scheduler
