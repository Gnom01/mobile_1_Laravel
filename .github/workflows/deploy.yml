name: Deploy (dev)

on:
  push:
    branches: ["dev"]

concurrency:
  group: deploy-dev
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script: |
            set -euo pipefail

            cd "${{ secrets.DEPLOY_PATH }}"

            # 1) Zatrzymanie kontenerów
            # Używamy down, aby upewnić się, że procesy nie trzymają plików w pamięci
            docker compose down || true

            # 2) Aktualizacja kodu z Git
            # Ponieważ storage/ i bootstrap/cache/ są teraz Named Volumes, 
            # Git nie spotka tam zablokowanych plików laravel.log czy widoków .php
            echo "Updating code via Git..."
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            # 3) Konfiguracja plików środowiskowych (.env)
            if [ ! -f .env.docker ]; then
              [ -f backend/env.docker.example ] && cp backend/env.docker.example .env.docker
            fi
            if [ ! -f backend/.env ]; then
              [ -f backend/.env.docker ] && cp backend/.env.docker backend/.env || cp backend/.env.example backend/.env || true
            fi

            # 4) Budowanie i start kontenerów
            # Docker sam podepnie wolumeny dla storage i cache
            docker compose up -d --build

            # 5) Naprawa uprawnień WEWNĄTRZ kontenerów (Kluczowy krok)
            # Musimy się upewnić, że user www-data wewnątrz Dockera ma prawa do wolumenów
            echo "Assigning permissions to Docker volumes..."
            docker compose exec -T php chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
            docker compose exec -T php chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache

            # 6) Operacje Laravela (Composer i Artisan)
            echo "Running Composer and Artisan commands..."
            docker compose exec -T php composer install --no-dev --optimize-autoloader
            
            # Generowanie klucza tylko jeśli go brak
            docker compose exec -T php sh -lc 'grep -q "^APP_KEY=base64:" .env || php artisan key:generate --force'

            # Optymalizacja konfiguracji
            docker compose exec -T php php artisan config:cache
            docker compose exec -T php php artisan route:cache
            docker compose exec -T php php artisan view:cache

            # 7) Restart workerów
            # Ważne, aby kolejki i scheduler widziały odświeżony kod i uprawnienia
            docker compose restart queue scheduler

            echo "DEPLOY SUCCESSFUL!"
