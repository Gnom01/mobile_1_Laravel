name: Deploy (dev)

on:
  push:
    branches: ["dev"]

concurrency:
  group: deploy-dev
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script: |
            set -euo pipefail

            cd "${{ secrets.DEPLOY_PATH }}"

            # 1) Stop containers (avoid locks)
            docker compose down || true

            # 2) HARD FIX: clean Laravel runtime dirs so git reset can't fail on unlink
            # If you store uploads locally in backend/storage/app, see the safe variant below.
            rm -rf backend/storage backend/bootstrap/cache || true
            mkdir -p backend/storage backend/bootstrap/cache
            chmod -R u+rwX,g+rwX backend/storage backend/bootstrap/cache || true

            # 3) Update code
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            # 4) Ensure Laravel .env exists and APP_KEY line is valid
            if [ -f backend/.env.docker ] && [ ! -f backend/.env ]; then
              cp -f backend/.env.docker backend/.env
            fi

            # Fix case where someone had "APP_KEY" without "="
            sed -i 's/^APP_KEY$/APP_KEY=/' backend/.env || true
            # Ensure APP_KEY exists at all
            grep -q '^APP_KEY=' backend/.env || echo 'APP_KEY=' >> backend/.env

            # 5) Build & start
            docker compose up -d --build

            # 6) Install deps (inside container)
            docker compose exec -T php composer install --no-dev --optimize-autoloader

            # 7) Generate key only if empty (keeps stable key across deploys)
            docker compose exec -T php sh -lc 'grep -q "^APP_KEY=base64:" .env || php artisan key:generate --force'

            # 8) Optional: migrations (uncomment if you want automatic migrations)
            # docker compose exec -T php php artisan migrate --force

            # 9) Restart workers
            docker compose restart queue scheduler
