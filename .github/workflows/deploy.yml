script: |
            set -euo pipefail
            cd "${{ secrets.DEPLOY_PATH }}"

            # 1) Stop containers
            docker compose down || true

            # 2) HARD FIX: Używamy SUDO, aby usunąć pliki stworzone przez Docker
            # To naprawi błąd "Permission denied" przy git reset
            sudo rm -rf backend/storage/framework/views/*
            sudo rm -rf backend/storage/logs/*
            sudo rm -rf backend/bootstrap/cache/*.php
            
            # Upewniamy się, że katalogi istnieją i należą do usera ubuntu przed git reset
            sudo chown -R ubuntu:ubuntu backend/storage backend/bootstrap/cache
            sudo chmod -R u+rwX backend/storage backend/bootstrap/cache

            # 3) Update code
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            # 4) Przygotowanie struktury pod Laravela
            mkdir -p backend/storage/framework/{cache,data,sessions,views} backend/storage/logs backend/bootstrap/cache
            # Tymczasowo dajemy pełne prawa, aby Docker mógł tam wejść
            sudo chmod -R 777 backend/storage backend/bootstrap/cache

            # 5) .env i inne (Twoja dotychczasowa logika)
            if [ ! -f .env.docker ]; then
              cp backend/.env.docker.example .env.docker || cp backend/.env.docker .env.docker || true
            fi
            if [ ! -f backend/.env ]; then
              cp backend/.env.example backend/.env || true
            fi

            # 6) Build & start
            docker compose up -d --build

            # 7) Fix permissions INSIDE container (Kluczowy krok)
            # To sprawia, że Laravel może pisać, a Ty nie masz błędów Permission Denied w logach
            docker compose exec -T php chown -R www-data:www-data storage bootstrap/cache
            docker compose exec -T php chmod -R 775 storage bootstrap/cache

            # 8) Reszta komend artisan
            docker compose exec -T php composer install --no-dev --optimize-autoloader
            docker compose exec -T php sh -lc 'grep -q "^APP_KEY=base64:" .env || php artisan key:generate --force'
            
            # 9) Restart, aby nowe uprawnienia zostały odświeżone w procesach
            docker compose restart queue scheduler
