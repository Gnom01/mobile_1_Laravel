name: Deploy (dev)

on:
  push:
    branches: ["dev"]

concurrency:
  group: deploy-dev
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script: |
            set -euo pipefail

            cd "${{ secrets.DEPLOY_PATH }}"

            # Stop containers (avoid weird file locks)
            docker compose down || true

            # Update code
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            # Ensure Laravel .env exists and APP_KEY line is valid
            if [ -f backend/.env.docker ] && [ ! -f backend/.env ]; then
              cp -f backend/.env.docker backend/.env
            fi
            # if someone has "APP_KEY" without "="
            sed -i 's/^APP_KEY$/APP_KEY=/' backend/.env || true
            # if missing completely
            grep -q '^APP_KEY=' backend/.env || echo 'APP_KEY=' >> backend/.env

            # Build & start
            docker compose up -d --build

            # Install deps
            docker compose exec -T php composer install --no-dev --optimize-autoloader

            # Generate key only if empty
            docker compose exec -T php sh -lc 'grep -q "^APP_KEY=base64:" .env || php artisan key:generate --force'

            # Migrate (optional — odkomentuj jeśli chcesz automatycznie)
            # docker compose exec -T php php artisan migrate --force

            # Restart workers
            docker compose restart queue scheduler
