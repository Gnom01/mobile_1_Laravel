name: Deploy (dev)

on:
  push:
    branches: ["dev"]

concurrency:
  group: deploy-dev
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          script: |
            set -euo pipefail

            cd "${{ secrets.DEPLOY_PATH }}"

            # 1) Zatrzymanie kontenerów przed aktualizacją
            docker compose down || true

            # 2) Czyszczenie pozostałości (Kluczowe dla stabilności)
            echo "Cleaning up leftovers..."
            sudo rm -rf backend/storage/framework/views/* || true
            sudo rm -rf backend/storage/logs/* || true
            sudo rm -rf backend/bootstrap/cache/*.php || true
            sudo chown -R ubuntu:ubuntu backend/storage backend/bootstrap/cache || true

            # 3) Aktualizacja kodu z Git
            echo "Updating code via Git..."
            git fetch origin
            git reset --hard origin/dev

            # 4) Konfiguracja plików .env
            echo "Configuring environment files..."
            if [ ! -f .env.docker ]; then
              if [ -f backend/.env.docker ]; then
                cp backend/.env.docker .env.docker
              elif [ -f backend/.env.docker.example ]; then
                cp backend/.env.docker.example .env.docker
              fi
            fi

            cp .env.docker .env || true
            if [ ! -f backend/.env ]; then
              cp .env.docker backend/.env || true
            fi

            # 5) Budowanie i start (Obsługa nowych ROZSZERZEŃ PHP)
            # Flaga --build wymusza sprawdzenie Dockerfile. Jeśli dodałeś tam nowe 
            # rozszerzenie (np. bcmath, gd), zostanie ono teraz doinstalowane.
            echo "Building and starting containers (updating extensions if needed)..."
            docker compose up -d --build

            # 6) Naprawa uprawnień w wolumenach
            echo "Assigning permissions inside volumes..."
            docker compose exec -T php chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
            docker compose exec -T php chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache

            # 7) Operacje Laravela (MIGRACJE I OPTYMALIZACJA)
            echo "Running Laravel tasks..."
            
            # Tworzymy strukturę folderów w wolumenie (zapobiega błędowi View path not found)
            docker compose exec -T php mkdir -p storage/framework/cache/data storage/framework/sessions storage/framework/views storage/framework/testing
            docker compose exec -T php chown -R www-data:www-data storage

            # Instalacja zależności composer
            docker compose exec -T php composer install --no-dev --optimize-autoloader

            # --- MIGRACJE BAZY DANYCH ---
            echo "Running database migrations..."
            docker compose exec -T php php artisan migrate --force

            # Generowanie klucza (tylko jeśli brak)
            docker compose exec -T php sh -lc 'grep -q "^APP_KEY=base64:" .env || php artisan key:generate --force'

            # Czyszczenie i budowanie cache
            docker compose exec -T php php artisan config:cache
            docker compose exec -T php php artisan route:cache
            docker compose exec -T php php artisan view:clear || true
            docker compose exec -T php php artisan view:cache

            # 8) Restart workerów
            echo "Restarting queue and scheduler..."
            docker compose restart queue scheduler

            echo "----------------------------------------"
            echo "DEPLOY SUCCESSFUL!"
            echo "----------------------------------------"
