version: '3.8'

services:
  # Serwer WWW (Nginx wewnątrz projektu)
  nginx:
    image: nginx:alpine
    container_name: mobile_1_laravel-nginx-1
    ports:
      - "8080:80"
    volumes:
      - ./backend:/var/www/html
      - laravel_storage:/var/www/html/storage
    depends_on:
      - php
    networks:
      - app-network

  # Główny proces PHP
  php:
    build:
      context: ./backend
      dockerfile: Dockerfile # upewnij się, że ścieżka jest poprawna
    container_name: mobile_1_laravel-php-1
    volumes:
      - ./backend:/var/www/html
      - laravel_storage:/var/www/html/storage
      - laravel_cache:/var/www/html/bootstrap/cache
    networks:
      - app-network

  # Kolejki (Queue)
  queue:
    build:
      context: ./backend
    container_name: mobile_1_laravel-queue-1
    command: php artisan queue:work
    volumes:
      - ./backend:/var/www/html
      - laravel_storage:/var/www/html/storage
      - laravel_cache:/var/www/html/bootstrap/cache
    depends_on:
      - php
    networks:
      - app-network

  # Harmonogram (Scheduler)
  scheduler:
    build:
      context: ./backend
    container_name: mobile_1_laravel-scheduler-1
    command: sh -c "while [ true ]; do php artisan schedule:run --no-interaction; sleep 60; done"
    volumes:
      - ./backend:/var/www/html
      - laravel_storage:/var/www/html/storage
      - laravel_cache:/var/www/html/bootstrap/cache
    depends_on:
      - php
    networks:
      - app-network

  # Baza danych
  mysql:
    image: mysql:8.0
    container_name: mobile_1_laravel-mysql-1
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

# DEFINICJA WOLUMENÓW - To tutaj dzieje się magia
volumes:
  laravel_storage:
  laravel_cache:
  mysql_data:
