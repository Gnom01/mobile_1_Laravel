services:
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./backend:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php

  php:
    build:
      context: ./docker/php
    volumes:
      - ./backend:/var/www/html
    working_dir: /var/www/html
    depends_on:
      - mysql

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: app
      MYSQL_USER: app
      MYSQL_PASSWORD: app
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
  # 1. Kontener Workera (do kolejki)
    queue:
        image: your-app-image  # Użyj tego samego obrazu co główna aplikacja
        restart: unless-stopped
        working_dir: /var/www/html
        command: php artisan queue:work --tries=3 --timeout=120
        volumes:
            - ./:/var/www/html # Montowanie kodu (jeśli używasz)
        depends_on:
            - mysql # lub nazwa twojej bazy
            - redis # jeśli używasz redisa
    # 2. Kontener Schedulera (do harmonogramu crm:sync)
    scheduler:
        image: your-app-image # Ten sam obraz co wyżej
        restart: unless-stopped
        working_dir: /var/www/html
        command: sh -c "while [ true ]; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"
        depends_on:
            - mysql
